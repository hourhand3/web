<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é˜…è¯»é€Ÿåº¦æµ‹è¯•</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      line-height: 1.7;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©ºé—´ */
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      font-weight: bold;
      color: #27ae60;
      font-size: 18px;
    }
    #passage {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #fdf6e3;
      border-left: 4px solid #f39c12;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 18px;
      line-height: 1.8;
    }
    #instructions {
      color: #7f8c8d;
      font-size: 14px;
      margin-top: 10px;
    }

    /* å›ºå®šåº•éƒ¨æŒ‰é’® */
    #endBtnFixed {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 14px 30px;
      font-size: 18px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ“– é˜…è¯»é€Ÿåº¦æµ‹è¯•</h1>

  <div class="section">
    <h2>1. ä¸Šä¼ æ–‡æœ¬æ–‡ä»¶ï¼ˆTXT æ ¼å¼ï¼‰</h2>
    <input type="file" id="fileInput" accept=".txt" />
    <p id="fileInfo"></p>
    <p id="instructions">æ”¯æŒå‡ åä¸‡å­—çš„å°è¯´æ–‡ä»¶ï¼Œå†…å®¹ä»…åœ¨æ‚¨æµè§ˆå™¨ä¸­å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
  </div>

  <div class="section">
    <h2>2. å¼€å§‹æµ‹è¯•</h2>
    <button id="startBtn" disabled>å¼€å§‹é˜…è¯»</button>
    <div id="result"></div>
    <div id="passage"></div>
  </div>

  <!-- å›ºå®šåœ¨åº•éƒ¨çš„ç»“æŸæŒ‰é’® -->
  <button id="endBtnFixed" disabled>ç»“æŸé˜…è¯»</button>

<script>
  // å…¨å±€å˜é‡
  let fullText = '';
  let selectedPassage = '';
  let startTime = null;

  const fileInput = document.getElementById('fileInput');
  const fileInfo = document.getElementById('fileInfo');
  const startBtn = document.getElementById('startBtn');
  const endBtnFixed = document.getElementById('endBtnFixed');
  const passageEl = document.getElementById('passage');
  const resultEl = document.getElementById('result');

  // âœ… æ··åˆè®¡æ•°ï¼šä¸­æ–‡å­—ç¬¦ + è‹±æ–‡å•è¯ + è¿ç»­æ•°å­—
  function countReadingUnits(text) {
    let total = 0;

    // è‹±æ–‡å•è¯ï¼ˆè¿ç»­å­—æ¯ï¼‰
    const englishWords = text.match(/[a-zA-Z]+/g);
    total += englishWords ? englishWords.length : 0;

    // è¿ç»­æ•°å­—ï¼ˆå¦‚ 2025, 3.14 â†’ æ³¨æ„ï¼š3.14 ä¼šè¢«æ‹†æˆ 3 å’Œ 14ï¼Œè‹¥éœ€ä¿ç•™å°æ•°å¯æ”¹æ­£åˆ™ï¼‰
    const numbers = text.match(/\d+/g);
    total += numbers ? numbers.length : 0;

    // ä¸­æ–‡å­—ç¬¦
    const chineseChars = text.match(/[\u4e00-\u9fff]/g);
    total += chineseChars ? chineseChars.length : 0;

    return total;
  }

  // è¯»å–æ–‡ä»¶
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function () {
      fullText = reader.result;
      const totalUnits = countReadingUnits(fullText);
      fileInfo.textContent = `å·²åŠ è½½ï¼š${file.name}ï¼ˆçº¦ ${totalUnits.toLocaleString()} é˜…è¯»å•å…ƒï¼‰`;
      startBtn.disabled = false;
      resetTest();
    };
    reader.onerror = () => alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
    reader.readAsText(file, 'UTF-8');
  });

  // é‡ç½®çŠ¶æ€
  function resetTest() {
    passageEl.style.display = 'none';
    passageEl.textContent = '';
    resultEl.textContent = '';
    endBtnFixed.style.display = 'none';
    endBtnFixed.disabled = true;
  }

  // æ™ºèƒ½æŠ½å–æ®µè½ï¼ˆä½¿ç”¨æ–°è®¡æ•°å‡½æ•°ï¼‰
  function extractRandomPassage(text) {
    const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
    if (paragraphs.length === 0) {
      const lines = text.split('\n').filter(l => l.trim().length > 0);
      if (lines.length === 0) return text.substring(0, 500);
      return lines.join('\n');
    }

    let startIndex = Math.floor(Math.random() * paragraphs.length);
    let current = '';
    let i = startIndex;
    const MIN_UNITS = 300;  // æœ€å°é˜…è¯»å•å…ƒæ•°
    const MAX_UNITS = 800;  // æœ€å¤§é˜…è¯»å•å…ƒæ•°

    while (countReadingUnits(current) < MIN_UNITS && i < paragraphs.length) {
      current += paragraphs[i] + '\n\n';
      i++;
    }

    if (countReadingUnits(current) < MIN_UNITS) {
      current = paragraphs.slice(0, Math.min(3, paragraphs.length)).join('\n\n');
    }

    // æ™ºèƒ½æˆªæ–­ï¼ˆåŸºäºåŸæ–‡ä½ç½®ï¼‰
    if (countReadingUnits(current) > MAX_UNITS) {
      let cutIndex = 0;
      let temp = '';
      const sentenceEnds = ['ã€‚', 'ï¼Ÿ', 'ï¼', '.', '?', '!'];

      // é€å­—ç¬¦æ„å»ºï¼Œç›´åˆ°æ¥è¿‘ MAX_UNITS
      for (let j = 0; j < current.length; j++) {
        temp += current[j];
        if (countReadingUnits(temp) >= MAX_UNITS) {
          cutIndex = j;
          // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„å¥å°¾
          let found = false;
          for (let k = j; k < Math.min(j + 150, current.length); k++) {
            if (sentenceEnds.includes(current[k])) {
              cutIndex = k + 1;
              found = true;
              break;
            }
          }
          if (!found) cutIndex = j;
          break;
        }
      }
      current = current.substring(0, cutIndex);
    }

    return current.trim();
  }

  // å¼€å§‹æµ‹è¯•
  startBtn.addEventListener('click', () => {
    if (!fullText) return;

    selectedPassage = extractRandomPassage(fullText);
    const unitCount = countReadingUnits(selectedPassage);
    if (unitCount < 50) {
      alert('æœªèƒ½æå–æœ‰æ•ˆæ–‡æœ¬ï¼Œè¯·æ¢ä¸€ä¸ªæ–‡ä»¶ã€‚');
      return;
    }

    passageEl.textContent = selectedPassage;
    passageEl.style.display = 'block';

    startTime = performance.now();

    endBtnFixed.style.display = 'block';
    endBtnFixed.disabled = false;
    startBtn.disabled = true;
  });

  // ç»“æŸæµ‹è¯•
  endBtnFixed.addEventListener('click', () => {
    if (startTime === null) return;

    const endTime = performance.now();
    const elapsedMs = endTime - startTime;
    const elapsedMin = elapsedMs / 60000;

    const unitCount = countReadingUnits(selectedPassage);
    const speed = Math.round(unitCount / elapsedMin);

    resultEl.innerHTML = `
      é˜…è¯»å•å…ƒæ•°ï¼š<strong>${unitCount}</strong>ï¼ˆæ±‰å­—+è‹±æ–‡å•è¯+æ•°å­—ï¼‰<br>
      ç”¨æ—¶ï¼š<strong>${(elapsedMs / 1000).toFixed(2)}</strong> ç§’<br>
      é˜…è¯»é€Ÿåº¦ï¼š<strong>${speed}</strong> å•å…ƒ/åˆ†é’Ÿ
    `;

    endBtnFixed.style.display = 'none';
    startBtn.disabled = false;
    startTime = null;

    resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
</script>
</body>
</html>